<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>CDN Tools</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" integrity="sha256-MBffSnbbXwHCuZtgPYiwMQbfE7z+GOZ7fBPCNB06Z98=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/octicons-css@19.8.0/octicons.min.css" integrity="sha256-s92JV1quA8D0bkOxnRHJ8S0aAacjMHYgCGkUFJAk/9s=" crossorigin="anonymous">
</head>

<body>
    <header>
        <nav class="navbar border-bottom navbar-expand-lg">
            <div class="container">
                <a class="navbar-brand" href="https://github.com/dnd-mdn">dnd-mdn</a>
            </div>
        </nav>
    </header>
    <main>
        <div class="container my-2">
            <h1 class="h3 mt-4 visually-hidden">CDN Tools</h1>
            <p>darfhgsdethg</p>
            <div class="card mb-5">
                <div class="card-header me-0">
                    <ol id="path" class="breadcrumb mb-1">
                        <li class="breadcrumb-item"><a href="?path=">cdn</a></li>
                    </ol>
                </div>
                <ul id="list" class="list-group list-group-flush">
                    <li class="list-group-item">
                        <div class="d-flex justify-content-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
  
        <div class="modal" tabindex="-1" id="modal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Modal title</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Modal body text goes here.</p>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.slim.min.js" integrity="sha384-5AkRS45j4ukf+JbWAfHL8P4onPA9p0KwwP7pUdjSQA3ss9edbJUJc/XcYAiheSSz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha256-gvZPYrsDwbwYJLD5yeBfcNujPhRoGOY831wwbIzz3t0=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js" integrity="sha256-4XodgW4TwIJuDtf+v6vDJ39FVxI0veC/kSCCmnFp7ck=" crossorigin="anonymous"></script>

    <script type="module">
        import { Octokit } from "https://esm.sh/@octokit/rest"

        const octokit = new Octokit()
        const modal = new bootstrap.Modal('#modal')
        
        async function load(path) {

            $('#path').html(path_html(path))

            $('#list').html(`<li class="list-group-item">
                <div class="d-flex justify-content-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </li>`)

            // Get data
            const { data } = await octokit.repos.getContent({
                owner: 'dnd-mdn',
                repo: 'cdn',
                path: path
            })

            // Sort nodes by type, then by name
            data.sort((a, b) => {
                if (a.type === 'dir') {
                    return b.type === 'dir' ? a.name > b.name : -1
                } else {
                    return b.type === 'dir' ? 1 : a.name > b.name
                }
            })

            $('#list').html(list_html(data))




        }





        load(getPath())

        function getPath(path) {
            return new URLSearchParams(window.location.search).get('path')
        }

        //window.history.pushState(null, null, `?path=${path}`)


        function path_html(path) {
            const parts = path ? path.split('/') : []
            let html = '<li class="breadcrumb-item"><a href="?path=">cdn</a></li>'

            for (let x = 1; x <= parts.length; x++) {
                const subpath = parts.slice(0, x).join('/')
                const active = x === parts.length ? ' active' : ''

                if (x < parts.length) {
                    html += `<li class="breadcrumb-item${active}">
                        <a href="?path=${subpath}">${parts[x - 1]}</a>
                    </li>`
                } else {
                    html += `<li class="breadcrumb-item active">${parts[x - 1]}</li>`
                }
            }

            return html
        }

        function list_html(nodes) {
            let html = ''

            nodes.forEach(node => {
                if (node.type === 'dir') {
                    html += `<li class="list-group-item list-group-item-action d-flex justify-content-between">
                        <div>
                            <i class="octicon-file-directory-fill-16 me-2 text-primary" title="Directory"></i>
                            <a href="?path=${node.path}">${node.name}</a>
                        </div>
                    </li>`
                } else {
                    html += `<li class="list-group-item list-group-item-action d-flex justify-content-between">
                        <div>
                            <i class="octicon-file-16 me-2" title="File"></i> ${node.name}
                        </div>
                        <div class="btn-group" role="group" data-path="${node.path}">
                            <button class="btn btn-sm btn-light py-0" title="Copy HTML" data-action="copy"><i class="octicon-copy-16"></i></button>
                            <button class="btn btn-sm btn-light py-0" title="Edit" data-action="edit"><i class="octicon-mark-github-16"></i></button>
                            <button class="btn btn-sm btn-light py-0" title="Cache info" data-action="info"><i class="octicon-info-16"></i></button>
                            <button class="btn btn-sm btn-light py-0" title="Purge Cache" data-action="purge"><i class="octicon-sync-16"></i></button>
                            
                            </div>
                    </li>`
                }
            })

            return html
        }

        function show_modal(title, body) {
            $('#modal .modal-title').html(title)
            $('#modal .modal-body').html(body)
            modal.show()
        }

     
        // Handle action buttons
        $("#list").on("click", "button", function (event) {
            const path = $(this).parent().data('path')
            const action = $(this).data('action')

            event.preventDefault();
           

            if (action === 'info'){
                show_modal('info','srfgaer')
            }
        });




        async function purge(node) {
            if (node.type === 'dir') {
                throw new Error('Unable to purge directories')
            }

            const urls = [
                `https://purge.jsdelivr.net/gh/dnd-mdn/cdn@latest/${node.path}`,
            ]

            if (node.path.endsWith('.js')) {
                urls.push(`https://purge.jsdelivr.net/gh/dnd-mdn/cdn@latest/${node.path.replace(/\.js$/, '.min.js')}`)
            } else if (node.path.endsWith('.css')) {
                urls.push(`https://purge.jsdelivr.net/gh/dnd-mdn/cdn@latest/${node.path.replace(/\.css$/, '.min.js')}`)
            }

            console.log(urls)
            //const response = await fetch(url)
            //const data = await response.json()

            //if (data.status !== 'finished') {
            //    throw new Error('Unable to clear cache')
            //}
        }



    </script>


</body>

</html>